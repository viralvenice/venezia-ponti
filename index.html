<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∞ Venezia Palazzi</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; background: linear-gradient(135deg, #f5f5f0 0%, #faf9f6 100%); overflow: hidden; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #81C9DF 0%, #6ab5cc 100%); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-box { background: rgba(255, 255, 255, 0.95); padding: 50px 40px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); text-align: center; }
        .login-box h1 { font-size: 32px; color: #333; margin-bottom: 10px; font-weight: 600; }
        .login-box p { color: #666; margin-bottom: 30px; font-size: 16px; }
        .login-box input { width: 100%; padding: 15px 20px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; margin-bottom: 20px; transition: all 0.3s; }
        .login-box input:focus { outline: none; border-color: #81C9DF; }
        .login-box button { width: 100%; padding: 15px; background: #81C9DF; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .login-box button:hover { background: #6ab5cc; transform: translateY(-2px); }
        #header { position: fixed; top: 0; left: 0; right: 0; height: 70px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-shadow: 0 2px 20px rgba(0,0,0,0.05); z-index: 1000; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-title { font-size: 24px; font-weight: 600; color: #333; }
        .language-switch { display: flex; gap: 10px; }
        .lang-btn { width: 40px; height: 40px; border: none; background: #f0f0f0; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        .lang-btn.active { background: #81C9DF; color: white; transform: scale(1.1); }
        .maps-links { display: flex; gap: 10px; flex-wrap: wrap; }
        .map-link { padding: 8px 15px; background: #f5f5f5; border: none; border-radius: 10px; cursor: pointer; font-size: 18px; transition: all 0.3s; text-decoration: none; color: #333; }
        .map-link.current { background: #81C9DF; color: white; font-weight: 600; }
        .map-link:hover:not(.current) { background: #e0e0e0; }
        #main-container { position: fixed; top: 70px; left: 0; right: 0; bottom: 0; display: flex; }
        #sidebar { width: 320px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); overflow-y: auto; box-shadow: 2px 0 20px rgba(0,0,0,0.05); }
        .sidebar-header { padding: 20px; background: #81C9DF; color: white; }
        .sidebar-header h2 { font-size: 20px; font-weight: 600; }
        .place-item { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .place-item:hover { background: #f8f8f8; }
        .place-item.active { background: #e8f6fa; border-left: 4px solid #81C9DF; }
        .place-emoji { font-size: 20px; }
        .place-info { flex: 1; }
        .place-name { font-weight: 600; color: #333; margin-bottom: 5px; }
        .place-duration { font-size: 13px; color: #81C9DF; }
        .drag-handle { cursor: grab; font-size: 16px; color: #999; }
        .drag-handle:active { cursor: grabbing; }
        #map { flex: 1; cursor: default; }
        #map.add-mode { cursor: crosshair; }
        .add-mode-indicator { position: fixed; top: 90px; left: 50%; transform: translateX(-50%); background: #81C9DF; color: white; padding: 15px 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(129, 201, 223, 0.4); z-index: 999; font-weight: 600; display: none; animation: pulse 2s infinite; }
        .add-mode-indicator.active { display: block; }
        @keyframes pulse { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }
        .mapboxgl-popup-content { padding: 0; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-width: 450px; overflow: hidden; }
        .popup-header { padding: 20px; background: linear-gradient(135deg, #81C9DF 0%, #6ab5cc 100%); color: white; position: relative; }
        .popup-title { font-size: 22px; font-weight: 600; margin-bottom: 5px; padding-right: 80px; word-wrap: break-word; }
        .popup-duration { font-size: 14px; opacity: 0.9; }
        .popup-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; }
        .popup-action-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .popup-action-btn:hover { background: rgba(255,255,255,0.4); transform: scale(1.1); }
        .popup-body { padding: 20px; max-height: 450px; overflow-y: auto; word-wrap: break-word; overflow-wrap: break-word; }
        .popup-body::-webkit-scrollbar { width: 6px; }
        .popup-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .popup-body::-webkit-scrollbar-thumb { background: #81C9DF; border-radius: 10px; }
        .popup-main-description { color: #333; line-height: 1.6; margin-bottom: 20px; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; }
        .carousel-container { position: relative; margin-top: 20px; }
        .carousel-section { display: none; animation: fadeIn 0.3s; }
        .carousel-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .section-header { padding: 15px; background: #f8f4f0; border-radius: 12px; margin-bottom: 15px; }
        .section-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 10px; word-wrap: break-word; }
        .section-description { color: #666; line-height: 1.6; font-size: 14px; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; }
        .carousel-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .carousel-btn { background: #81C9DF; color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 18px; transition: all 0.3s; }
        .carousel-btn:hover:not(:disabled) { background: #6ab5cc; transform: scale(1.1); }
        .carousel-btn:disabled { background: #ccc; cursor: not-allowed; }
        .carousel-dots { display: flex; gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ddd; transition: all 0.3s; cursor: pointer; }
        .dot.active { background: #81C9DF; width: 24px; border-radius: 4px; }
        .info-box { margin-top: 20px; padding: 15px; border-radius: 12px; border-left: 4px solid #81C9DF; }
        .how-to-arrive { background: #f0f8fa; }
        .tickets-hours { background: #fff4e6; border-left-color: #ffa726; }
        .info-box h4 { color: #81C9DF; margin-bottom: 10px; font-size: 16px; }
        .tickets-hours h4 { color: #ffa726; }
        .info-box p { color: #666; line-height: 1.6; font-size: 14px; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; }
        .edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; overflow-y: auto; }
        .edit-modal.active { display: flex; align-items: flex-start; justify-content: center; padding: 50px 20px; }
        .edit-modal-content { background: white; border-radius: 16px; padding: 30px; max-width: 700px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .edit-modal-content::-webkit-scrollbar { width: 8px; }
        .edit-modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .edit-modal-content::-webkit-scrollbar-thumb { background: #81C9DF; border-radius: 10px; }
        .edit-modal-content h2 { margin-bottom: 25px; color: #333; font-size: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; font-family: inherit; transition: all 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #81C9DF; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .subsections-header { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px; }
        .subsections-header h3 { font-size: 18px; color: #333; }
        .btn-add-subsection { background: #81C9DF; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        .btn-add-subsection:hover { background: #6ab5cc; transform: translateY(-2px); }
        .subsection-item { background: #f8f8f8; padding: 20px; border-radius: 12px; margin-bottom: 15px; position: relative; border: 2px solid #e0e0e0; }
        .subsection-item .remove-subsection { position: absolute; top: 15px; right: 15px; background: #ff6b6b; color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold; transition: all 0.3s; }
        .subsection-item .remove-subsection:hover { background: #ff5252; transform: rotate(90deg) scale(1.1); }
        .modal-actions { display: flex; gap: 10px; margin-top: 30px; }
        .modal-actions button { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-save { background: #81C9DF; color: white; }
        .btn-save:hover { background: #6ab5cc; transform: translateY(-2px); }
        .btn-cancel { background: #f0f0f0; color: #333; }
        .btn-cancel:hover { background: #e0e0e0; }
        .admin-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #81C9DF; border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 20px rgba(129, 201, 223, 0.4); transition: all 0.3s; z-index: 999; }
        .admin-btn:hover { transform: scale(1.1); box-shadow: 0 6px 30px rgba(129, 201, 223, 0.6); }
        .admin-panel { display: none; position: fixed; top: 70px; right: 0; width: 400px; height: calc(100% - 70px); background: white; box-shadow: -2px 0 20px rgba(0,0,0,0.1); padding: 30px; overflow-y: auto; z-index: 998; }
        .admin-panel.active { display: block; }
        .admin-panel h3 { margin-bottom: 20px; color: #333; }
        .admin-panel button { width: 100%; padding: 15px; margin-bottom: 10px; background: #81C9DF; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; text-align: left; }
        .admin-panel button:hover { background: #6ab5cc; transform: translateX(-5px); }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h1>üè∞ Venezia Palazzi</h1>
            <p>Inserisci la password per accedere</p>
            <input type="password" id="password-input" placeholder="Password">
            <button onclick="checkPassword()">Accedi</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <div id="header">
            <div class="header-left">
                <span class="header-title">üè∞ <span id="header-title-text">Palazzi di Venezia</span></span>
                <div class="language-switch">
                    <button class="lang-btn active" onclick="setLanguage('it')">IT</button>
                    <button class="lang-btn" onclick="setLanguage('en')">EN</button>
                </div>
            </div>
            <div class="maps-links">
                <a href="https://viralvenice.github.io/venezia-musei/" class="map-link" title="Musei">üèõÔ∏è</a>
                <a href="https://viralvenice.github.io/venezia-palazzi/" class="map-link current" title="Palazzi">üè∞</a>
                <a href="https://viralvenice.github.io/venezia-ponti/" class="map-link" title="Ponti">üåâ</a>
                <a href="https://viralvenice.github.io/venezia-chiese/" class="map-link" title="Chiese">‚õ™</a>
                <a href="https://viralvenice.github.io/venezia-attrazioni/" class="map-link" title="Attrazioni">üé≠</a>
                <a href="https://viralvenice.github.io/venezia-foto/" class="map-link" title="Spot Fotografici">üì∏</a>
            </div>
        </div>

        <div class="add-mode-indicator" id="add-mode-indicator">Clicca sulla mappa per aggiungere un palazzo</div>

        <div id="main-container">
            <div id="sidebar">
                <div class="sidebar-header"><h2 id="sidebar-title">Legenda Palazzi</h2></div>
                <div id="places-list"></div>
            </div>
            <div id="map"></div>
        </div>

        <button class="admin-btn" onclick="toggleAdmin()">‚öôÔ∏è</button>

        <div id="admin-panel" class="admin-panel">
            <h3>Gestione Dati</h3>
            <button onclick="toggleAddMode()">Aggiungi Palazzo sulla Mappa</button>
            <button onclick="exportData()">Esporta Dati (JSON)</button>
            <button onclick="document.getElementById('import-file').click()">Importa Dati (JSON)</button>
            <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
            <button onclick="resetToDefault()">Ripristina Dati Predefiniti</button>
        </div>

        <div id="edit-modal" class="edit-modal">
            <div class="edit-modal-content">
                <h2 id="modal-title">Modifica Palazzo</h2>
                <form id="edit-form">
                    <div class="form-row">
                        <div class="form-group"><label>Nome (Italiano) *</label><input type="text" id="edit-name-it" required></div>
                        <div class="form-group"><label>Nome (Inglese) *</label><input type="text" id="edit-name-en" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Durata visita (minuti)</label><input type="number" id="edit-duration" min="0"></div>
                        <div class="form-group"><label>Latitudine *</label><input type="number" step="0.000001" id="edit-lat" required></div>
                    </div>
                    <div class="form-group"><label>Longitudine *</label><input type="number" step="0.000001" id="edit-lng" required></div>
                    <div class="form-group"><label>Descrizione (Italiano) *</label><textarea id="edit-desc-it" required></textarea></div>
                    <div class="form-group"><label>Descrizione (Inglese) *</label><textarea id="edit-desc-en" required></textarea></div>
                    <div class="form-group"><label>Come Arrivare (Italiano)</label><textarea id="edit-arrive-it"></textarea></div>
                    <div class="form-group"><label>Come Arrivare (Inglese)</label><textarea id="edit-arrive-en"></textarea></div>
                    <div class="form-group"><label>Orari e Biglietti (Italiano)</label><textarea id="edit-tickets-it" placeholder="Lascia vuoto se non applicabile"></textarea></div>
                    <div class="form-group"><label>Orari e Biglietti (Inglese)</label><textarea id="edit-tickets-en" placeholder="Leave empty if not applicable"></textarea></div>
                    <div class="subsections-header"><h3>Sottosezioni</h3><button type="button" class="btn-add-subsection" onclick="addSubsection()">Aggiungi</button></div>
                    <div id="subsections-container"></div>
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeEditModal()">Annulla</button>
                        <button type="submit" class="btn-save">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWxleGVhbmdlbGEiLCJhIjoiY21nNnltb3lqMG00NjJtc2U1MGwzeGhkYiJ9.-b-5VYMsx38e2YB6JB4qEw';
        const PASSWORD = 'venezia2025';
        const PLACE_EMOJI = 'üè∞';
        const STORAGE_KEY = 'venezia-palazzi-data';
        let currentLanguage = 'it', map, markers = [], currentPopup = null, addMode = false, editingMuseumId = null, subsectionCounter = 0;
        
        const defaultMuseums = [{
            id:1,
            name:{it:"Ca' d'Oro",en:"Ca' d'Oro"},
            duration:60,
            coordinates:[12.3331,45.4404],
            description:{it:"Splendido palazzo gotico veneziano affacciato sul Canal Grande.",en:"Splendid Venetian Gothic palace overlooking the Grand Canal."},
            subsections:[{title:{it:"Storia",en:"History"},description:{it:"Costruito nel XV secolo per la famiglia Contarini.",en:"Built in the 15th century for the Contarini family."}}],
            howToArrive:{it:"Vaporetto: linea 1 fermata Ca' d'Oro.",en:"Vaporetto: line 1 stop Ca' d'Oro."},
            ticketsHours:{it:"Aperto 10:00-18:00. Biglietto ‚Ç¨10.",en:"Open 10:00-18:00. Ticket ‚Ç¨10."}
        }];
        
        let museums = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultMuseums;

        function checkPassword() {
            if (document.getElementById('password-input').value === PASSWORD) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').classList.remove('hidden');
                initializeApp();
            } else alert('Password errata!');
        }
        document.getElementById('password-input').addEventListener('keypress', e => { if (e.key === 'Enter') checkPassword(); });

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateLanguage();
        }
        
        function updateLanguage() {
            const texts = {it:{headerTitle:'Palazzi di Venezia',sidebarTitle:'Legenda Palazzi'},en:{headerTitle:'Venice Palaces',sidebarTitle:'Palaces Legend'}};
            document.getElementById('header-title-text').textContent = texts[currentLanguage].headerTitle;
            document.getElementById('sidebar-title').textContent = texts[currentLanguage].sidebarTitle;
            renderPlacesList();
            if (currentPopup) currentPopup.remove();
        }

        function initializeApp() { initMap(); renderPlacesList(); addMarkers(); }

        function initMap() {
            map = new mapboxgl.Map({container:'map',style:'mapbox://styles/mapbox/light-v11',center:[12.3350,45.4371],zoom:13.5});
            map.addControl(new mapboxgl.NavigationControl(), 'top-right');
            map.on('click', e => { if (addMode) { openEditModalForNew(e.lngLat); toggleAddMode(); } });
        }

        function toggleAddMode() {
            addMode = !addMode;
            document.getElementById('add-mode-indicator').classList.toggle('active');
            document.getElementById('map').classList.toggle('add-mode');
            if (addMode) document.getElementById('admin-panel').classList.remove('active');
        }

        function renderPlacesList() {
            const list = document.getElementById('places-list');
            list.innerHTML = '';
            museums.forEach((m, idx) => {
                const item = document.createElement('div');
                item.className = 'place-item';
                item.draggable = true;
                item.dataset.index = idx;
                item.onclick = (e) => {
                    if (e.target.classList.contains('drag-handle')) return;
                    document.querySelectorAll('.place-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    if (m.coordinates) { map.flyTo({center:m.coordinates,zoom:16}); showPopup(m); }
                };
                item.ondragstart = (e) => { e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', idx); };
                item.ondragover = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
                item.ondrop = (e) => {
                    e.preventDefault();
                    const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIdx = parseInt(item.dataset.index);
                    if (fromIdx !== toIdx) {
                        const temp = museums[fromIdx];
                        museums.splice(fromIdx, 1);
                        museums.splice(toIdx, 0, temp);
                        saveData();
                        renderPlacesList();
                    }
                };
                item.innerHTML = `<span class="drag-handle">‚ò∞</span><span class="place-emoji">${PLACE_EMOJI}</span><div class="place-info"><div class="place-name">${m.name[currentLanguage]}</div>${m.duration ? `<div class="place-duration">‚è±Ô∏è ${m.duration} min</div>` : ''}</div>`;
                list.appendChild(item);
            });
        }

        function addMarkers() {
            markers.forEach(m => m.remove());
            markers = [];
            museums.forEach(m => {
                if (!m.coordinates) return;
                const el = document.createElement('div');
                el.innerHTML = PLACE_EMOJI;
                el.style.fontSize = '28px';
                el.style.cursor = 'pointer';
                const marker = new mapboxgl.Marker(el).setLngLat(m.coordinates).addTo(map);
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showPopup(m);
                });
                markers.push(marker);
            });
        }

        function showPopup(m) {
            if (currentPopup) currentPopup.remove();
            const sub = m.subsections || [];
            const popupContent = `
                <div class="popup-header">
                    <div class="popup-title">${m.name[currentLanguage]}</div>
                    ${m.duration ? `<div class="popup-duration">‚è±Ô∏è ${m.duration} ${currentLanguage==='it'?'minuti':'minutes'}</div>` : ''}
                    <div class="popup-actions">
                        <button class="popup-action-btn" onclick="editMuseum(${m.id})">‚úèÔ∏è</button>
                        <button class="popup-action-btn" onclick="deleteMuseum(${m.id})">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="popup-body">
                    <div class="popup-main-description">${m.description[currentLanguage]}</div>
                    ${sub.length > 0 ? `
                        <div class="carousel-container" id="carousel-${m.id}">
                            ${sub.map((s,i) => `<div class="carousel-section ${i===0?'active':''}" data-index="${i}"><div class="section-header" style="background:${getColorForSection(i)};"><div class="section-title">${s.title[currentLanguage]}</div><div class="section-description">${s.description[currentLanguage]}</div></div></div>`).join('')}
                            ${sub.length>1 ? `<div class="carousel-nav"><button class="carousel-btn" onclick="changeSlide(${m.id},-1)">‚Üê</button><div class="carousel-dots">${sub.map((_,i) => `<div class="dot ${i===0?'active':''}" data-index="${i}"></div>`).join('')}</div><button class="carousel-btn" onclick="changeSlide(${m.id},1)">‚Üí</button></div>` : ''}
                        </div>` : ''}
                    ${m.howToArrive && (m.howToArrive[currentLanguage] && m.howToArrive[currentLanguage].trim()) ? `<div class="info-box how-to-arrive"><h4>üö¢ ${currentLanguage==='it'?'Come Arrivare':'How to Get There'}</h4><p>${m.howToArrive[currentLanguage]}</p></div>` : ''}
                    ${m.ticketsHours && (m.ticketsHours[currentLanguage] && m.ticketsHours[currentLanguage].trim()) ? `<div class="info-box tickets-hours"><h4>üé´ ${currentLanguage==='it'?'Orari e Biglietti':'Hours and Tickets'}</h4><p>${m.ticketsHours[currentLanguage]}</p></div>` : ''}
                </div>`;
            currentPopup = new mapboxgl.Popup({maxWidth:'450px',offset:25}).setLngLat(m.coordinates).setHTML(popupContent).addTo(map);
        }

        window.changeSlide = function(mid, dir) {
            const c = document.getElementById(`carousel-${mid}`);
            if (!c) return;
            const secs = c.querySelectorAll('.carousel-section'), dots = c.querySelectorAll('.dot');
            let cur = Array.from(secs).findIndex(s => s.classList.contains('active')), nw = cur + dir;
            if (nw < 0) nw = secs.length - 1;
            if (nw >= secs.length) nw = 0;
            secs[cur].classList.remove('active'); dots[cur].classList.remove('active');
            secs[nw].classList.add('active'); dots[nw].classList.add('active');
        };
        
        function getColorForSection(i) {
            const colors = ['#f8f4f0','#f0f8fa','#faf0f5','#f5f8f0','#faf5f0'];
            return colors[i % colors.length];
        }

        window.editMuseum = function(id) {
            const m = museums.find(x => x.id === id);
            if (!m) return;
            editingMuseumId = id;
            openEditModal(m);
        };
        
        window.deleteMuseum = function(id) {
            if (!confirm(currentLanguage==='it'?'Vuoi eliminare questo palazzo?':'Delete this palace?')) return;
            museums = museums.filter(m => m.id !== id);
            saveData();
            renderPlacesList();
            addMarkers();
            if (currentPopup) currentPopup.remove();
        };

        function openEditModalForNew(ll) {
            editingMuseumId = null;
            const m = {name:{it:'',en:''},duration:60,coordinates:[ll.lng,ll.lat],description:{it:'',en:''},subsections:[],howToArrive:{it:'',en:''},ticketsHours:{it:'',en:''}};
            openEditModal(m);
        }

        function openEditModal(m) {
            document.getElementById('modal-title').textContent = editingMuseumId ? '‚úèÔ∏è Modifica Palazzo' : '‚ûï Aggiungi Nuovo Palazzo';
            document.getElementById('edit-name-it').value = m.name.it;
            document.getElementById('edit-name-en').value = m.name.en;
            document.getElementById('edit-duration').value = m.duration || '';
            document.getElementById('edit-lat').value = m.coordinates[1];
            document.getElementById('edit-lng').value = m.coordinates[0];
            document.getElementById('edit-desc-it').value = m.description.it;
            document.getElementById('edit-desc-en').value = m.description.en;
            document.getElementById('edit-arrive-it').value = m.howToArrive?.it || '';
            document.getElementById('edit-arrive-en').value = m.howToArrive?.en || '';
            document.getElementById('edit-tickets-it').value = m.ticketsHours?.it || '';
            document.getElementById('edit-tickets-en').value = m.ticketsHours?.en || '';
            const container = document.getElementById('subsections-container');
            container.innerHTML = '';
            subsectionCounter = 0;
            if (m.subsections && m.subsections.length > 0) m.subsections.forEach(s => addSubsectionToForm(s));
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            editingMuseumId = null;
        }

        function addSubsectionToForm(s = null) {
            const container = document.getElementById('subsections-container');
            const id = subsectionCounter++;
            const div = document.createElement('div');
            div.className = 'subsection-item';
            div.dataset.id = id;
            div.innerHTML = `
                <button type="button" class="remove-subsection" onclick="removeSubsection(${id})">√ó</button>
                <div class="form-group"><label>Titolo (IT)</label><input type="text" class="subsection-title-it" value="${s?.title.it || ''}"></div>
                <div class="form-group"><label>Titolo (EN)</label><input type="text" class="subsection-title-en" value="${s?.title.en || ''}"></div>
                <div class="form-group"><label>Descrizione (IT)</label><textarea class="subsection-desc-it">${s?.description.it || ''}</textarea></div>
                <div class="form-group"><label>Descrizione (EN)</label><textarea class="subsection-desc-en">${s?.description.en || ''}</textarea></div>
            `;
            container.appendChild(div);
        }

        window.addSubsection = function() { addSubsectionToForm(); };
        window.removeSubsection = function(id) {
            const item = document.querySelector(`.subsection-item[data-id="${id}"]`);
            if (item) item.remove();
        };

        document.getElementById('edit-form').addEventListener('submit', e => {
            e.preventDefault();
            const subsections = [];
            document.querySelectorAll('.subsection-item').forEach(item => {
                const titleIt = item.querySelector('.subsection-title-it').value;
                const titleEn = item.querySelector('.subsection-title-en').value;
                const descIt = item.querySelector('.subsection-desc-it').value;
                const descEn = item.querySelector('.subsection-desc-en').value;
                if (titleIt && titleEn) subsections.push({title:{it:titleIt,en:titleEn},description:{it:descIt,en:descEn}});
            });
            const museumData = {
                id: editingMuseumId || Date.now(),
                name: {it:document.getElementById('edit-name-it').value, en:document.getElementById('edit-name-en').value},
                duration: parseInt(document.getElementById('edit-duration').value) || null,
                coordinates: [parseFloat(document.getElementById('edit-lng').value), parseFloat(document.getElementById('edit-lat').value)],
                description: {it:document.getElementById('edit-desc-it').value, en:document.getElementById('edit-desc-en').value},
                subsections: subsections,
                howToArrive: {it:document.getElementById('edit-arrive-it').value, en:document.getElementById('edit-arrive-en').value},
                ticketsHours: {it:document.getElementById('edit-tickets-it').value, en:document.getElementById('edit-tickets-en').value}
            };
            if (editingMuseumId) {
                const index = museums.findIndex(m => m.id === editingMuseumId);
                museums[index] = museumData;
            } else {
                museums.push(museumData);
            }
            saveData();
            renderPlacesList();
            addMarkers();
            closeEditModal();
            if (currentPopup) currentPopup.remove();
            showPopup(museumData);
        });

        function toggleAdmin() { document.getElementById('admin-panel').classList.toggle('active'); }

        function exportData() {
            const dataStr = JSON.stringify(museums, null, 2);
            const blob = new Blob([dataStr], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `venezia-palazzi-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    museums = data;
                    saveData();
                    renderPlacesList();
                    addMarkers();
                    alert(currentLanguage==='it'?'Dati importati con successo!':'Data imported successfully!');
                } catch (err) {
                    alert(currentLanguage==='it'?'Errore nell\'importazione: file non valido':'Import error: invalid file');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function resetToDefault() {
            if (confirm(currentLanguage==='it'?'Ripristinare i dati predefiniti? Tutti i dati attuali saranno persi.':'Reset to default data? All current data will be lost.')) {
                museums = [...defaultMuseums];
                saveData();
                renderPlacesList();
                addMarkers();
                if (currentPopup) currentPopup.remove();
                alert(currentLanguage==='it'?'Dati ripristinati!':'Data restored!');
            }
        }

        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(museums)); }
    </script>
</body>
</html>